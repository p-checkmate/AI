name: Deploy AI Server (Main)

on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Free runner disk space
              run: |
                  sudo rm -rf /usr/share/dotnet
                  sudo rm -rf /usr/local/lib/android
                  sudo rm -rf /opt/ghc
                  sudo rm -rf /usr/share/swift
                  sudo rm -rf /usr/share/rust
                  docker system prune -af || true
                  echo "Disk cleanup completed"

            - name: Checkout Source Code
              uses: actions/checkout@v4

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Set Image Tag
              run: |
                  IMAGE_TAG=$(date +%Y%m%d%H%M%S)
                  echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

            - name: Build Docker Image
              run: |
                  IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/checkmate-ai-server
                  docker build \
                    -t $IMAGE_NAME:${{ env.IMAGE_TAG }} \
                    -t $IMAGE_NAME:latest \
                    --build-arg BUCKET_NAME=${{ secrets.BUCKET_NAME }} \
                    --build-arg AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
                    --build-arg AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
                    .

            - name: Push Docker Image
              run: |
                  IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/checkmate-ai-server
                  docker push $IMAGE_NAME:${{ env.IMAGE_TAG }}
                  docker push $IMAGE_NAME:latest
